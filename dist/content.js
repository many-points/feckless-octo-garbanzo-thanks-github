// Generated by CoffeeScript 1.10.0
(function() {
  var processArray, vkdl;

  Array.prototype.first = function() {
    return this[0];
  };

  NodeList.prototype.first = function() {
    return this[0];
  };

  NodeList.prototype.forEach = Array.prototype.forEach;

  Element.prototype._addEventListener = Element.prototype.addEventListener;

  Element.prototype.addEventListener = function(event, listener, useCapture) {
    this._addEventListener(event, listener, useCapture);
    if (!this.listenerList) {
      this.listenerList = {};
    }
    if (!this.listenerList[event]) {
      this.listenerList[event] = [];
    }
    return this.listenerList[event].push(listener);
  };

  processArray = function(items, process) {
    var index;
    if (items.length === 0) {
      return;
    }
    index = 0;
    return setTimeout(function() {
      var item;
      item = items[index];
      process(item);
      index += 1;
      if (index < items.length) {
        return setTimeout(arguments.callee, 25);
      }
    }, 25);
  };

  vkdl = {
    get_url: function(parent) {
      return parent.querySelector("input").value.split('?').first(null);
    },
    get_song_name: function(parent) {
      return parent.querySelector(".title_wrap").innerText.trim(null).replace('/', '-').concat('.mp3');
    },
    download_file_event: function() {
      return function(event) {
        var name, options, url;
        event.preventDefault();
        url = vkdl.get_url(this.parentElement);
        name = vkdl.get_song_name(this.parentElement);
        options = {
          url: url,
          filename: name,
          conflictAction: 'uniquify'
        };
        return chrome.runtime.sendMessage(options);
      };
    },
    add_event: function(node) {
      var button, ref;
      button = node.querySelector('.area.clear_fix');
      if (((ref = button.listenerList) != null ? ref.contextmenu : void 0) != null) {
        return;
      }
      button.addEventListener('contextmenu', vkdl.download_file_event(null));
    },
    add_event_to_existing_nodes: function() {
      var nodes;
      nodes = document.querySelectorAll('.audio');
      processArray(nodes, vkdl.add_event);
    },
    observer: new MutationObserver(function(mutations) {
      return processArray(mutations, function(mutation) {
        return processArray(mutation.addedNodes, function(node) {
          var nodes, ref;
          if ((ref = node.classList) != null ? ref.contains('audio') : void 0) {
            return vkdl.add_event(node);
          } else {
            nodes = typeof node.querySelectorAll === "function" ? node.querySelectorAll('.audio') : void 0;
            if ((nodes != null) && nodes.length !== 0) {
              return processArray(nodes, vkdl.add_event);
            }
          }
        });
      });
    }),
    start_observer: function() {
      var box_layer, config, page_body;
      config = {
        childList: true,
        subtree: true
      };
      page_body = document.querySelector('#page_body');
      box_layer = document.querySelector('#box_layer');
      if (page_body != null) {
        vkdl.observer.observe(page_body, config);
      }
      if (box_layer != null) {
        return vkdl.observer.observe(box_layer, config);
      }
    }
  };

  vkdl.add_event_to_existing_nodes(null);

  vkdl.start_observer(null);

}).call(this);
